# Инструкции по развертыванию системы депозитов

## Настройка Cloud Functions для автоматического начисления процентов

### 1. Установка Firebase CLI
```bash
npm install -g firebase-tools
```

### 2. Вход в Firebase
```bash
firebase login
```

### 3. Инициализация проекта (если еще не сделано)
```bash
firebase init functions
```

### 4. Установка зависимостей
```bash
cd functions
npm install
```

### 5. Развертывание функций
```bash
cd ..
firebase deploy --only functions
```

## Функции

### dailyDepositInterest
- **Расписание**: Каждый день в 11:00 по ташкенту (06:00 UTC)
- **Функция**: Автоматически начисляет проценты по всем активным депозитам
- **Логика**: 
  - Получает все активные депозиты
  - Рассчитывает дневной доход для каждого депозита
  - Группирует по пользователям для оптимизации
  - Обновляет баланс пользователей

### manualDepositInterest
- **Тип**: HTTP функция (вызывается вручную)
- **Доступ**: Только для администратора
- **Функция**: Ручное начисление процентов для тестирования

## Мониторинг

### Просмотр логов
```bash
firebase functions:log
```

### Просмотр конкретной функции
```bash
firebase functions:log --only dailyDepositInterest
```

## Тестирование

### Локальное тестирование
```bash
cd functions
npm run serve
```

### Тестирование в продакшене
1. Создайте тестовый депозит
2. Дождитесь 11:00 по ташкенту
3. Проверьте логи в Firebase Console
4. Убедитесь, что баланс пользователя увеличился

## Важные моменты

1. **Время**: Функция запускается в 11:00 по ташкенту (Asia/Tashkent)
2. **Точность**: Проценты начисляются с точностью до 4 знаков после запятой
3. **Безопасность**: Используются транзакции для предотвращения race conditions
4. **Логирование**: Все операции логируются для мониторинга

## Структура данных

### Депозит в Firestore
```javascript
{
  userId: "user_id",
  amount: 1000,
  interestRate: 15,
  startDate: timestamp,
  status: "active",
  level: 20
}
```

### Обновление баланса пользователя
```javascript
{
  money: currentMoney + dailyInterest
}
```
